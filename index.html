<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UVA OpenAlex Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; max-width: 1200px; }
    h1 { margin-bottom: 0.25rem; }
    .controls { background: #f0f8ff; padding: 12px 16px; border-radius: 8px; margin: 16px 0; }
    select, button { padding: 6px 10px; margin-right: 10px; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #2c5aa0; color: #fff; cursor: pointer; }
    button:hover { background: #1e3f70; }
    #status { margin-left: 10px; font-weight: 600; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 12px; margin: 20px 0; }
    .stat-card { border: 1px solid #ddd; border-radius: 8px; padding: 14px; text-align: center; background: #fafafa; }
    .stat-number { font-size: 2rem; font-weight: 700; color: #2c5aa0; }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .chart-box { border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; background: #fff; height: 420px; box-sizing: border-box; }
    .chart-title { text-align: center; margin-bottom: 8px; font-weight: 600; }
    canvas { width: 100% !important; height: 360px !important; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: left; }
    th { background: #f5f5f5; }
    .debug { font-family: monospace; font-size: 0.8rem; background: #f0f8ff; padding: 8px; border-radius: 6px; margin-top: 10px; display: none; }
  </style>
</head>
<body>
  <h1>ðŸŸ  UVA OpenAlex Dashboard</h1>
  <p>OpenAlex data for University of Virginia (ROR: 
    <a href="https://ror.org/0153tk833" target="_blank">https://ror.org/0153tk833</a>)</p>

  <div class="controls">
    <label>From year:
      <select id="startYear">
        <option value="2014">2014</option>
        <option value="2015">2015</option>
        <option value="2016">2016</option>
        <option value="2017">2017</option>
        <option value="2018">2018</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024" selected>2024</option>
      </select>
    </label>
    <label>To year:
      <select id="endYear">
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025" selected>2025</option>
        <option value="2026">2026</option>
      </select>
    </label>
    <button onclick="loadData()">ðŸ”„ Update</button>
    <span id="status"></span>
  </div>

  <div id="stats" class="stats-grid" style="display:none;"></div>

  <div class="charts-row">
    <div class="chart-box">
      <div class="chart-title">ðŸ“ˆ Publication Trends</div>
      <canvas id="trendsChart"></canvas>
    </div>
    <div class="chart-box">
      <div class="chart-title">ðŸŽ¨ Open Access Status</div>
      <canvas id="oaChart"></canvas>
    </div>
  </div>
  <div class="charts-row" style="margin-top: 30px;">
  <div class="chart-box">
    <div class="chart-title">ðŸ“š Top Journals</div>
    <canvas id="journalsChart"></canvas>
  </div

  <div style="margin: 30px 0;">
    <h3>ðŸ’° Top Funding Agencies</h3>
    <div id="fundersList" style="background: #f9f9f9; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;"></div>
  </div>

  <div style="margin:30px 0">
    <h3>ðŸ”¬ Top Domains</h3>
    <div id="domainsList" style="background:#f9f9f9;padding:15px;border-radius:8px;max-height:200px;overflow:auto;"></div>
  </div>

  <h3>ðŸ“‹ Top 10 Most Cited Works</h3>
  <table id="worksTable" style="display:none;">
    <thead>
      <tr>
        <th>Title</th>
        <th>Year</th>
        <th>OA Status</th>
        <th>Citations</th>
      </tr>
    </thead>
    <tbody id="worksBody"></tbody>
  </table>

  <div id="debug" class="debug"></div>

  <script>
    const UVA_ROR = "https://ror.org/0153tk833";
    const BASE_URL = "https://api.openalex.org";
    let trendsChart = null;
    let oaChart = null;
    let fundersChart = null; 
    let sortedJournals = [];
    
async function loadData() {
  const statusEl = document.getElementById('status');
  const debugEl = document.getElementById('debug');
  statusEl.textContent = 'Loading...';
  debugEl.style.display = 'block';
  debugEl.textContent = '';

  const startYear = document.getElementById('startYear').value;
  const endYear = document.getElementById('endYear').value;

  const filter = `institutions.ror:${UVA_ROR},from_publication_date:${startYear}-01-01,to_publication_date:${endYear}-12-31`;
  
  debugEl.textContent = `Fetching ALL works (${filter})`;

  try {
    let allWorks = [];
    let cursor = '*';  // First page cursor
    let pageCount = 0;
    const maxPages = 400;  // Safety cap (~80,000 works max)
    
    // Cursor pagination through ALL results
    while (cursor && pageCount < maxPages) {
      const url = `${BASE_URL}/works?filter=${encodeURIComponent(filter)}&per-page=200&sort=cited_by_count:desc&cursor=${cursor}`;
      
      debugEl.textContent += `\nðŸ“„ Page ${++pageCount}: `;
      const res = await fetch(url);
      const data = await res.json();
      
      const works = data.results || [];
      allWorks.push(...works);
      
      debugEl.textContent += `${works.length} works (total: ${allWorks.length})`;
      
      // Get next cursor from meta.next_cursor
      cursor = data.meta?.next_cursor || null;
      
      // Rate limiting - pause between pages
      if (cursor) {
        await new Promise(resolve => setTimeout(resolve, 200));
      }
    }
    
    debugEl.textContent += `\nâœ… TOTAL: ${allWorks.length} works loaded!`;
    
    if (!allWorks.length) {
      statusEl.textContent = 'No works found for this range';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('worksTable').style.display = 'none';
      if (trendsChart) trendsChart.destroy();
      if (oaChart) oaChart.destroy();
      if (window.journalsChart) window.journalsChart.destroy();
      return;
    }

    // Process ALL works (not just top 100)
    updateStats(allWorks);
    updateTrendsChart(allWorks);
    updateOAChart(allWorks);
    updateWorksTable(allWorks.slice(0, 50));  // Show top 50 in table
    updateFunders(allWorks);
    updateDomains(allWorks);
    sortedJournals = updateJournalsChart(allWorks);
    updateJournalsChartDisplay();
    
    statusEl.textContent = `Loaded ${allWorks.length} works`;

  } catch (e) {
    console.error(e);
    debugEl.textContent += `\nError: ${e.message}`;
    statusEl.textContent = 'Error loading data';
  }
}

    function updateStats(works) {
      const totalWorks = works.length;
      const oaWorks = works.filter(w => w.open_access && w.open_access.is_oa).length;
      const totalCitations = works.reduce((sum, w) => sum + (w.cited_by_count || 0), 0);
      const avgCitations = totalWorks ? (totalCitations / totalWorks) : 0;
      const apcTotal = works.reduce((sum, w) => {
        const v = w.apc_list?.value_usd;
        return sum + (v ? Number(v) : 0);
      }, 0);

      const statsDiv = document.getElementById('stats');
      statsDiv.innerHTML = `
        <div class="stat-card">
          <h3>Total Works</h3>
          <div class="stat-number">${totalWorks.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Open Access</h3>
          <div class="stat-number">${oaWorks.toLocaleString()}</div>
          <small>${((oaWorks/totalWorks)*100 || 0).toFixed(1)}%</small>
        </div>
        <div class="stat-card">
          <h3>Total Citations</h3>
          <div class="stat-number">${totalCitations.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Avg Citations</h3>
          <div class="stat-number">${avgCitations.toFixed(1)}</div>
        </div>
        <div class="stat-card">
          <h3>Est. APCs</h3>
          <div class="stat-number">$${(apcTotal/1000).toLocaleString('en-US',{maximumFractionDigits:0})}K</div>
        </div>
      `;
      statsDiv.style.display = 'grid';
    }

    function updateTrendsChart(works) {
      const yearly = {};
      works.forEach(w => {
        const y = w.publication_year;
        if (y) yearly[y] = (yearly[y] || 0) + 1;
      });
      const years = Object.keys(yearly).sort((a,b)=>a-b);

      const ctx = document.getElementById('trendsChart');
      if (trendsChart) trendsChart.destroy();
      trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'Works',
            data: years.map(y => yearly[y]),
            borderColor: '#2c5aa0',
            backgroundColor: 'rgba(44,90,160,0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updateOAChart(works) {
      const counts = { gold:0, hybrid:0, bronze:0, green:0, closed:0 };
      works.forEach(w => {
        const status = w.open_access && w.open_access.is_oa ? (w.open_access.oa_status || 'green') : 'closed';
        if (!counts[status]) counts[status] = 0;
        counts[status]++;
      });

      const labels = Object.keys(counts).filter(k => counts[k] > 0);
      const data = labels.map(k => counts[k]);

      const ctx = document.getElementById('oaChart');
      if (oaChart) oaChart.destroy();
      oaChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#ffd700','#ff8c00','#cd853f','#90ee90','#d3d3d3']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateWorksTable(works) {
      const tbody = document.getElementById('worksBody');
      tbody.innerHTML = '';
      works.slice(0,10).forEach(w => {
        const row = tbody.insertRow();
        const title = (w.display_name || 'Untitled');
        const shortTitle = title.length > 70 ? title.slice(0,67) + 'â€¦' : title;
        const link = w.id.replace('https://openalex.org/','https://explore.openalex.org/works/');
        row.innerHTML = `
          <td><a href="${link}" target="_blank">${shortTitle}</a></td>
          <td>${w.publication_year || 'N/A'}</td>
          <td>${w.open_access && w.open_access.is_oa ? 'Open' : 'Closed'}</td>
          <td style="font-weight:bold;">${w.cited_by_count || 0}</td>
        `;
      });
      document.getElementById('worksTable').style.display = 'table';
    }

    function updateFunders(works) {
          const funders = {};
          works.forEach(w => (w.grants||[]).forEach(g => {
            const name = g.funder_display_name || g.funder || 'Unknown';
            funders[name] = (funders[name]||0) + 1;
          }));
          const top = Object.entries(funders).sort(([,a],[,b])=>b-a).slice(0,10);
          document.getElementById('fundersList').innerHTML = top.map(([n,c])=>`<div>${n}: ${c}</div>`).join('');
        }

    function updateDomains(works) {
      const domains = {};
      works.forEach(w => (w.concepts||[]).forEach(c => {
        if (c.level >= 0 && c.level <= 2) {
          const name = c.display_name;
          domains[name] = (domains[name]||0) + 1;
        }
      }));
      const top = Object.entries(domains).sort(([,a],[,b])=>b-a).slice(0,10);
      document.getElementById('domainsList').innerHTML = top.map(([n,c])=>`<div>${n}: ${c}</div>`).join('');
    }

    function updateJournalsChart(works) {
      const journals = {};
      works.forEach(w => {
      const venue = w.host_venue?.display_name || 
              w.primary_location?.source?.display_name || 
              w.primary_location?.source?.id?.split('/').pop()?.slice(0,20) || 
              'Unknown Journal';
        journals[venue] = (journals[venue] || 0) + 1;
     });
     const sorted = Object.entries(journals)
       .sort(([,a], [,b]) => b - a)
       .slice(0, 10);
     return sorted;
    }

function updateJournalsChartDisplay() {
  console.log('ðŸŽ¯ Chart function called, sortedJournals:', sortedJournals);  
  if (sortedJournals.length === 0) return;
  
  const canvas = document.getElementById('journalsChart');
  if (!canvas) {
    console.log('âŒ Canvas not found');
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Nuclear option - clear everything and start fresh
  if (window.journalsChart) {
    try {
      window.journalsChart.destroy();
    } catch (e) {
      console.log('âš ï¸ Destroy failed, continuing...');
      // Canvas might still have old chart - clear it manually
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }
  
  // Create new chart
  window.journalsChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedJournals.map(([venue]) => venue),
      datasets: [{
        label: 'Publications',
        data: sortedJournals.map(([,count]) => count),
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Top 10 Journals' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  console.log('âœ… Journals chart created');
}

function updateFunders(works) {
  const funders = {};
  
  works.forEach(w => {
    // OpenAlex funders are in w.funders.awards or w.funders
    const funderList = w.funders?.awards || w.funders || [];
    
    funderList.forEach(funder => {
      const name = funder.name || funder.display_name || funder.id?.split('/').pop() || 'Unknown Funder';
      funders[name] = (funders[name] || 0) + 1;
    });
  });
  
  const sortedFunders = Object.entries(funders)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 10);
  
  return sortedFunders;
}


    window.addEventListener('load', () => {
      setTimeout(loadData, 500);
    });
  </script>
</body>
</html>



