<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UVA OpenAlex Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; max-width: 1200px; }
    h1 { margin-bottom: 0.25rem; }
    .controls { background: #f0f8ff; padding: 12px 16px; border-radius: 8px; margin: 16px 0; }
    select, button { padding: 6px 10px; margin-right: 10px; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #2c5aa0; color: #fff; cursor: pointer; }
    button:hover { background: #1e3f70; }
    #loadButton {
  background: #4CAF50;
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  margin-bottom: 20px;
}

#loadButton:hover:not(:disabled) {
  background: #45a049;
}

#loadButton:disabled {
  background: #cccccc;
  cursor: not-allowed;
}
#workLimit {
  padding: 8px;
  border-radius: 4px;
  border: 1px solid #ccc;
  background: white;
  margin-left: 8px;
}

.controls label {
  margin-left: 15px;
  font-weight: 500;
}
#institutionSelect {
  height: 100px;
  padding: 8px;
  border-radius: 4px;
}
    #status { margin-left: 10px; font-weight: 600; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap: 12px; margin: 20px 0; }
    .stat-card { border: 1px solid #ddd; border-radius: 8px; padding: 14px; text-align: center; background: #fafafa; }
    .stat-number { font-size: 2rem; font-weight: 700; color: #2c5aa0; }
    .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
    .chart-box { border: 1px solid #ddd; border-radius: 8px; padding: 12px 16px; background: #fff; height: 420px; box-sizing: border-box; }
    .chart-title { text-align: center; margin-bottom: 8px; font-weight: 600; }
    canvas { width: 100% !important; height: 360px !important; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 8px 10px; text-align: left; }
    th { background: #f5f5f5; }
    .debug { font-family: monospace; font-size: 0.8rem; background: #f0f8ff; padding: 8px; border-radius: 6px; margin-top: 10px; display: none; }
  </style>
</head>
<body>
  <h1>üü† UVA OpenAlex Dashboard</h1>
  <p>OpenAlex data for University of Virginia (ROR: 
    <a href="https://ror.org/0153tk833" target="_blank">https://ror.org/0153tk833</a>)</p>

  <div class="controls">
    <button id="loadButton" onclick="loadData()">üìä Load Data</button>
     <label>Institutions (by ROR): 
    <select id="institutionSelect" multiple>
      <option value="https://ror.org/0153tk833" selected>UVA Main</option>
      <option value="https://ror.org/00wn7d965">UVA Health System</option>
      <option value="https://ror.org/046kb4y45">UVA Medical Center</option>
      <option value="https://ror.org/02f588d44">UVA Hospital</option>
      <option value="https://ror.org/01krywm46">UVA Children's Hospital</option>
      <option value="https://ror.org/04w75nz84">UVA Cancer Center</option>
    </select>
  </label>
     <label>Limit: 
    <select id="workLimit">
      <option value="1000">Fast (1K works)</option>
      <option value="5000">Balanced (5K works)</option>
      <option value="10000" selected>Full (10K works)</option>
      <option value="20000">Max (20K works)</option>
      <option value="50000">Ultra Max (50K works)</option>
    </select>
  </label>
    <label>From year:
      <select id="startYear">
        <option value="2014">2014</option>
        <option value="2015">2015</option>
        <option value="2016">2016</option>
        <option value="2017">2017</option>
        <option value="2018">2018</option>
        <option value="2019">2019</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024" selected>2024</option>
      </select>
    </label>
    <label>To year:
      <select id="endYear">
        <option value="2023">2023</option>
        <option value="2024">2024</option>
        <option value="2025" selected>2025</option>
        <option value="2026">2026</option>
      </select>
    </label>
    <span id="status"></span>
  </div>

  <div id="stats" class="stats-grid" style="display:none;"></div>

  <div class="charts-row">
    <div class="chart-box">
      <div class="chart-title">üìà Publication Trends</div>
      <canvas id="trendsChart"></canvas>
    </div>
    <div class="chart-box">
      <div class="chart-title">üé® Open Access Status</div>
      <canvas id="oaChart"></canvas>
    </div>
  </div>
  <div class="charts-row" style="margin-top: 30px;">
  <div class="chart-box">
    <div class="chart-title">üìö Top Journals</div>
    <canvas id="journalsChart"></canvas>
  </div>
  <div class="chart-box">
    <div class="chart-title">üí∞ Top Funders</div>
    <canvas id="fundersChart"></canvas>
  </div>
  </div>

  <div style="margin:30px 0">
    <h3>üî¨ Top Domains</h3>
    <div id="domainsList" style="background:#f9f9f9;padding:15px;border-radius:8px;max-height:200px;overflow:auto;"></div>
  </div>

  <h3>üìã Top 10 Most Cited Works</h3>
  <table id="worksTable" style="display:none;">
    <thead>
      <tr>
        <th>Title</th>
        <th>Year</th>
        <th>OA Status</th>
        <th>Citations</th>
      </tr>
    </thead>
    <tbody id="worksBody"></tbody>
  </table>

  <div id="debug" class="debug"></div>

  <script>
    const UVA_ROR = "https://ror.org/0153tk833";
    const BASE_URL = "https://api.openalex.org";
    let trendsChart = null;
    let oaChart = null;
    let fundersChart = null; 
    let sortedJournals = [];
    
async function loadData() {
  const loadBtn = document.getElementById('loadButton');
  const statusEl = document.getElementById('status');
  const debugEl = document.getElementById('debug');
  const workLimit = parseInt(document.getElementById('workLimit').value);
  const maxWorks = Math.min(workLimit, 300 * 200); // Never exceed 60K

  
  loadBtn.disabled = true;
  loadBtn.textContent = 'Loading...';
  statusEl.textContent = 'Loading...';
  debugEl.style.display = 'block';
  debugEl.textContent = '';

  const startYear = document.getElementById('startYear').value;
  const endYear = document.getElementById('endYear').value;
  const selectedRors = Array.from(document.getElementById('institutionSelect').selectedOptions)
    .map(option => option.value);
  
  if (selectedRors.length === 0) {
    statusEl.textContent = 'Select at least one organization';
    loadBtn.disabled = false;
    loadBtn.textContent = 'üìä Load Data';
    return;
  }
  
  // Build filter with multiple RORs
  const rorFilter = selectedRors.map(ror => `institutions.ror:${ror}`).join('|');
  const dateFilter = `from_publication_date:${startYear}-01-01,to_publication_date:${endYear}-12-31`;

// ‚úÖ CRITICAL: Encode each part separately, then combine
  const filter = `${rorFilter},${dateFilter}`;
  const url = `${BASE_URL}/works?filter=${encodeURIComponent(filter)}&per-page=200`;


  debugEl.textContent = `RORs: ${selectedRors.length} | Filter: ${rorFilter}`;

  try {
    let allWorks = [];
    let cursor = '*';  // First page cursor
    let pageCount = 0;
    const maxPages = Math.ceil(workLimit / 200); // Calculate max pages based on user limit

    debugEl.textContent += `\n‚öôÔ∏è Target: ${workLimit} works max (${maxPages} pages)`;

      console.log('üîç Raw RORs:', selectedRors);
      console.log('üîç ROR filter:', rorFilter);
      console.log('üîç Full filter:', filter);
      console.log('üîç Encoded URL:',`${BASE_URL}/works?filter=${encodeURIComponent(filter)}&per-page=200`);
    // Cursor pagination through ALL results
    while (cursor && pageCount < maxPages) {

      const url = `${BASE_URL}/works?filter=${encodeURIComponent(filter)}&per-page=200&sort=cited_by_count:desc&cursor=${cursor}`;
      
      debugEl.textContent += `\nüìÑ Page ${++pageCount}: `;
      const res = await fetch(url);
      const data = await res.json();
      
      const works = data.results || [];
      allWorks.push(...works);
      
       // Trim if we exceed limit
      if (allWorks.length > workLimit) {
        allWorks = allWorks.slice(0, workLimit);
      }
      
      debugEl.textContent += `${works.length} works (total: ${allWorks.length})`;
      
      // Get next cursor from meta.next_cursor
      cursor = data.meta?.next_cursor || null;
      
      // Rate limiting - pause between pages
      if (cursor) {
        await new Promise(resolve => setTimeout(resolve, 200));
      }
    }
    
    debugEl.textContent += `\n‚úÖ TOTAL: ${allWorks.length} works loaded!`;
    
    if (!allWorks.length) {
      statusEl.textContent = 'No works found for this range';
      document.getElementById('stats').style.display = 'none';
      document.getElementById('worksTable').style.display = 'none';
      if (trendsChart) trendsChart.destroy();
      if (oaChart) oaChart.destroy();
      if (window.journalsChart) window.journalsChart.destroy();
      return;
    }

    // Process ALL works (not just top 100)
    updateStats(allWorks);
    updateTrendsChart(allWorks);
    updateOAChart(allWorks);
    updateWorksTable(allWorks.slice(0, 50));  // Show top 50 in table
    updateFunders(allWorks);
    updateDomains(allWorks);
    sortedJournals = updateJournalsChart(allWorks);
    updateJournalsChartDisplay();
    sortedFunders = updateFunders(allWorks); 
    updateFundersChartDisplay(); 
    
    statusEl.textContent = `Loaded ${allWorks.length} works`;

  } catch (e) {
    console.error(e);
    debugEl.textContent += `\nError: ${e.message}`;
    statusEl.textContent = 'Error loading data';
  }
  loadBtn.disabled = false;
  loadBtn.textContent = 'üìä Load Data';
}

    function updateStats(works) {
      const totalWorks = works.length;
      const oaWorks = works.filter(w => w.open_access && w.open_access.is_oa).length;
      const totalCitations = works.reduce((sum, w) => sum + (w.cited_by_count || 0), 0);
      const avgCitations = totalWorks ? (totalCitations / totalWorks) : 0;
      const apcTotal = works.reduce((sum, w) => {
        const v = w.apc_list?.value_usd;
        return sum + (v ? Number(v) : 0);
      }, 0);

      const statsDiv = document.getElementById('stats');
      statsDiv.innerHTML = `
        <div class="stat-card">
          <h3>Total Works</h3>
          <div class="stat-number">${totalWorks.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Open Access</h3>
          <div class="stat-number">${oaWorks.toLocaleString()}</div>
          <small>${((oaWorks/totalWorks)*100 || 0).toFixed(1)}%</small>
        </div>
        <div class="stat-card">
          <h3>Total Citations</h3>
          <div class="stat-number">${totalCitations.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <h3>Avg Citations</h3>
          <div class="stat-number">${avgCitations.toFixed(1)}</div>
        </div>
        <div class="stat-card">
          <h3>Est. APCs</h3>
          <div class="stat-number">$${(apcTotal/1000).toLocaleString('en-US',{maximumFractionDigits:0})}K</div>
        </div>
      `;
      statsDiv.style.display = 'grid';
    }

    function updateTrendsChart(works) {
      const yearly = {};
      works.forEach(w => {
        const y = w.publication_year;
        if (y) yearly[y] = (yearly[y] || 0) + 1;
      });
      const years = Object.keys(yearly).sort((a,b)=>a-b);

      const ctx = document.getElementById('trendsChart');
      if (trendsChart) trendsChart.destroy();
      trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: years,
          datasets: [{
            label: 'Works',
            data: years.map(y => yearly[y]),
            borderColor: '#2c5aa0',
            backgroundColor: 'rgba(44,90,160,0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function updateOAChart(works) {
      const counts = { gold:0, hybrid:0, bronze:0, green:0, closed:0 };
      works.forEach(w => {
        const status = w.open_access && w.open_access.is_oa ? (w.open_access.oa_status || 'green') : 'closed';
        if (!counts[status]) counts[status] = 0;
        counts[status]++;
      });

      const labels = Object.keys(counts).filter(k => counts[k] > 0);
      const data = labels.map(k => counts[k]);

      const ctx = document.getElementById('oaChart');
      if (oaChart) oaChart.destroy();
      oaChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#ffd700','#ff8c00','#cd853f','#90ee90','#d3d3d3']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function updateWorksTable(works) {
      const tbody = document.getElementById('worksBody');
      tbody.innerHTML = '';
      works.slice(0,10).forEach(w => {
        const row = tbody.insertRow();
        const title = (w.display_name || 'Untitled');
        const shortTitle = title.length > 70 ? title.slice(0,67) + '‚Ä¶' : title;
        const link = w.id.replace('https://openalex.org/','https://explore.openalex.org/works/');
        row.innerHTML = `
          <td><a href="${link}" target="_blank">${shortTitle}</a></td>
          <td>${w.publication_year || 'N/A'}</td>
          <td>${w.open_access && w.open_access.is_oa ? 'Open' : 'Closed'}</td>
          <td style="font-weight:bold;">${w.cited_by_count || 0}</td>
        `;
      });
      document.getElementById('worksTable').style.display = 'table';
    }

    function updateFunders(works) {
          const funders = {};
          works.forEach(w => (w.grants||[]).forEach(g => {
            const name = g.funder_display_name || g.funder || 'Unknown';
            funders[name] = (funders[name]||0) + 1;
          }));
          const top = Object.entries(funders).sort(([,a],[,b])=>b-a).slice(0,10);
          document.getElementById('fundersList').innerHTML = top.map(([n,c])=>`<div>${n}: ${c}</div>`).join('');
        }

    function updateDomains(works) {
      const domains = {};
      works.forEach(w => (w.concepts||[]).forEach(c => {
        if (c.level >= 0 && c.level <= 2) {
          const name = c.display_name;
          domains[name] = (domains[name]||0) + 1;
        }
      }));
      const top = Object.entries(domains).sort(([,a],[,b])=>b-a).slice(0,10);
      document.getElementById('domainsList').innerHTML = top.map(([n,c])=>`<div>${n}: ${c}</div>`).join('');
    }

function updateJournalsChart(works) {
  const journals = {};
  works.forEach(w => {
    let venue = w.host_venue?.display_name;
    
    // Fallback 1: Primary location source
    if (!venue && w.primary_location?.source) {
      venue = w.primary_location.source.display_name || 
              w.primary_location.source.id?.split('/').pop()?.slice(0,25);
    }
    
    // Fallback 2: First ISSN
    if (!venue && w.issn?.[0]) {
      venue = `ISSN:${w.issn[0]}`;
    }
    
    // Fallback 3: Concepts (subject areas)
    if (!venue && w.concepts?.[0]) {
      venue = `Topic:${w.concepts[0].display_name?.slice(0,20)}`;
    }
    
    venue = venue || 'Unknown Journal';
    journals[venue] = (journals[venue] || 0) + 1;
  });
  
  return Object.entries(journals)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 10);
}


function updateJournalsChartDisplay() {
  console.log('üéØ Chart function called, sortedJournals:', sortedJournals);  
  if (sortedJournals.length === 0) return;
  
  const canvas = document.getElementById('journalsChart');
  if (!canvas) {
    console.log('‚ùå Canvas not found');
    return;
  }
  
  const ctx = canvas.getContext('2d');
  
  // Nuclear option - clear everything and start fresh
  if (window.journalsChart) {
    try {
      window.journalsChart.destroy();
    } catch (e) {
      console.log('‚ö†Ô∏è Destroy failed, continuing...');
      // Canvas might still have old chart - clear it manually
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }
  
  // Create new chart
window.journalsChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: sortedJournals.map(([venue]) => venue),
    datasets: [{
      label: 'Publications',
      data: sortedJournals.map(([,count]) => count),
      backgroundColor: sortedJournals.map(([venue]) => 
        venue === 'Unknown Journal' ? 
          'rgba(255, 193, 7, 0.6)' :  // üü° Yellow for Unknown
          'rgba(54, 162, 235, 0.6)'   // üîµ Blue for real journals
      ),
      borderColor: sortedJournals.map(([venue]) => 
        venue === 'Unknown Journal' ? 
          'rgba(255, 193, 7, 1)' : 
          'rgba(54, 162, 235, 1)'
      ),
      borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Top 10 Journals' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
  
  console.log('‚úÖ Journals chart created');
}

function updateFunders(works) {
  const funders = {};
  
  works.forEach(w => {
    // OpenAlex funders are in w.funders.awards or w.funders
    const funderList = w.funders?.awards || w.funders || [];
    
    funderList.forEach(funder => {
      const name = funder.name || funder.display_name || funder.id?.split('/').pop() || 'Unknown Funder';
      funders[name] = (funders[name] || 0) + 1;
    });
  });
  
  const sortedFunders = Object.entries(funders)
    .sort(([,a], [,b]) => b - a)
    .slice(0, 10);
  
  return sortedFunders;
}

function updateFundersChartDisplay() {
  if (sortedFunders.length === 0) return;
  
  const canvas = document.getElementById('fundersChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Safe destroy
  if (window.fundersChart && typeof window.fundersChart.destroy === 'function') {
    try {
      window.fundersChart.destroy();
    } catch (e) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  }
  
  window.fundersChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedFunders.map(([funder]) => funder),
      datasets: [{
        label: 'Funded Publications',
        data: sortedFunders.map(([,count]) => count),
        backgroundColor: 'rgba(75, 192, 192, 0.6)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: { display: true, text: 'Top 10 Funders' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}


  </script>
</body>
</html>



