<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UVA OpenAlex Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 1200px; }
    .container { margin-bottom: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
    .stat-card { border: 1px solid #ddd; padding: 20px; text-align: center; border-radius: 8px; background: #f9f9f9; }
    .stat-number { font-size: 2.5em; font-weight: bold; color: #2c5aa0; margin: 10px 0; }
    .controls { background: #f0f8ff; padding: 15px; border-radius: 8px; margin: 20px 0; }
    select, button { padding: 8px 12px; margin: 0 10px 0 0; border: 1px solid #ccc; border-radius: 4px; }
    button { background: #2c5aa0; color: white; cursor: pointer; }
    button:hover { background: #1e3f70; }
    .chart-box { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin: 20px 0; background: white; }
    .chart-title { text-align: center; margin-bottom: 15px; color: #333; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #f5f5f5; font-weight: 600; }
    .loading { opacity: 0.6; }
    .chart-box {
  height: 400px;  /* Fixed container height */
  position: relative;
}
canvas {
  max-height: 100% !important;
}

  </style>
</head>
<body>
  <h1>ðŸŸ  UVA OpenAlex Dashboard</h1>
  <p>OpenAlex data for University of Virginia (ROR: <a href="https://ror.org/0153tk833">https://ror.org/0153tk833</a>)</p>

  <div class="controls container">
    <label>From Year: 
      <select id="startYear">
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
        <option value="2023">2023</option>
        <option value="2024" selected>2024</option>
      </select>
    </label>
    <label>To Year: 
      <select id="endYear">
        <option value="2024">2024</option>
        <option value="2025" selected>2025</option>
        <option value="2026">2026</option>
      </select>
    </label>
    <button onclick="loadData()">ðŸ”„ Load Data</button>
    <span id="status" style="margin-left: 20px; font-weight: bold;"></span>
  </div>

  <div id="stats" class="stats-grid" style="display: none;"></div>

  <div class="container">
    <div class="chart-box" style="display: none;" id="trendsBox">
      <h3 class="chart-title">ðŸ“ˆ Publication Trends</h3>
      <canvas id="trendsChart" height="300"></canvas>
    </div>
  </div>

  <div class="container">
    <table id="worksTable" style="display: none;">
      <thead>
        <tr>
          <th>Title</th>
          <th>Year</th>
          <th>OA Status</th>
          <th>Citations</th>
        </tr>
      </thead>
      <tbody id="worksBody"></tbody>
    </table>
  </div>

  <script>
    let trendsChart = null;

    async function loadData() {
      document.body.classList.add('loading');
      document.getElementById('status').textContent = 'Loading...';

      try {
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;
        
        const filter = `institutions.ror:https://ror.org/0153tk833,from_publication_date:${startYear}-01-01,to_publication_date:${endYear}-12-31`;
        const url = `https://api.openalex.org/works?filter=${encodeURIComponent(filter)}&per-page=100&sort=cited_by_count:desc`;
        
        const response = await fetch(url);
        const data = await response.json();
        const works = data.results || [];

        // Stats cards
        const totalWorks = works.length;
        const oaWorks = works.filter(w => w.is_oa).length;
        const totalCitations = works.reduce((sum, w) => sum + (w.cited_by_count || 0), 0);
        
        document.getElementById('stats').innerHTML = `
          <div class="stat-card">
            <h3>Total Works</h3>
            <div class="stat-number">${totalWorks.toLocaleString()}</div>
          </div>
          <div class="stat-card">
            <h3>Open Access</h3>
            <div class="stat-number">${oaWorks}</div>
            <small>${((oaWorks/totalWorks)*100 || 0).toFixed(1)}%</small>
          </div>
          <div class="stat-card">
            <h3>Total Citations</h3>
            <div class="stat-number">${totalCitations.toLocaleString()}</div>
          </div>
        `;
        document.getElementById('stats').style.display = 'grid';

        // Trends chart
        const yearlyData = {};
        works.forEach(work => {
          const year = work.publication_year;
          if (year) yearlyData[year] = (yearlyData[year] || 0) + 1;
        });
        
        const years = Object.keys(yearlyData).sort((a, b) => a - b);
        
        // Trends chart - FIXED HEIGHT
const canvas = document.getElementById('trendsChart');
canvas.style.height = '350px';  // Force fixed height
canvas.style.width = '100%';

if (trendsChart) trendsChart.destroy();
trendsChart = new Chart(canvas, {
  type: 'line',
  data: {
    labels: years,
    datasets: [{
      label: 'Publications',
      data: years.map(year => yearlyData[year]),
      borderColor: '#2c5aa0',
      backgroundColor: 'rgba(44, 90, 160, 0.1)',
      fill: true,
      tension: 0.4,
      pointRadius: 3
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: **false**,  // CRITICAL: Fixed container needed
    interaction: { intersect: false },
    scales: {
      y: { 
        beginAtZero: true,
        ticks: { stepSize: 1 }  // Force integer steps
      }
    },
    plugins: {
      legend: { display: true }
    }
  }
});

        document.getElementById('trendsBox').style.display = 'block';

        // Works table
        const tbody = document.getElementById('worksBody');
        tbody.innerHTML = '';
        works.slice(0, 10).forEach(work => {
          const row = tbody.insertRow();
          const title = (work.display_name || 'No title').substring(0, 60) + (work.display_name && work.display_name.length > 60 ? '...' : '');
          row.innerHTML = `
            <td><a href="${work.id.replace('https://openalex.org/', 'https://explore.openalex.org/works/')}" target="_blank">${title}</a></td>
            <td>${work.publication_year || 'N/A'}</td>
            <td>${work.is_oa ? (work.open_access?.oa_status || 'OA') : 'Closed'}</td>
            <td style="font-weight: bold;">${work.cited_by_count || 0}</td>
          `;
        });
        document.getElementById('worksTable').style.display = 'table';

        document.getElementById('status').textContent = `Loaded ${totalWorks} UVA works (${oaWorks} OA)`;
        
      } catch (error) {
        document.getElementById('status').textContent = 'Error loading data';
        console.error('Error:', error);
      }
      
      document.body.classList.remove('loading');
    }

    // Load data on page load
    window.addEventListener('load', () => {
      setTimeout(loadData, 500);
    });
  </script>
</body>
</html>

